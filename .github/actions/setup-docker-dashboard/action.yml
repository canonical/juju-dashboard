name: Set up Juju Dashboard using Docker
description: Set up Juju Dashboard using the Docker image.
inputs:
  dashboard-ref:
    description: Git reference to build dashboard from.
    default: main
    required: false
  run:
    description: Whether to run the dashboard after building the image.
    required: false
  controller-ws-address:
    description: The address of the Juju controller.
    required: true
  is-juju:
    description: Whether the controller is a Juju (not JIMM) controller.
    required: false
    default: true
outputs:
  address:
    description: The address of the Docker container (if the run option is `true`).
    value: ${{ steps.dashboard-address.outputs.address }}
runs:
  using: "composite"
  steps:
    - name: Set up Juju Dashboard release
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.dashboard-ref }}
        path: juju-dashboard-local-release
    - name: Configure Dashboard
      run: |
        cat << EOF > ${{ github.workspace }}/juju-dashboard-local-release/public/config.js
        var jujuDashboardConfig = {
          controllerAPIEndpoint: "${{ inputs.controller-ws-address }}",
          baseAppURL: "/",
          identityProviderURL: "",
          isJuju: ${{ inputs.is-juju }},
          analyticsEnabled: false,
        };
        EOF
      shell: bash
    - name: Configure nginx
      run: |
        pip install jinja2-cli
        cd '${{ github.workspace }}/juju-dashboard-local-release'
        echo '{"port": 80, "dashboard_root": "/srv"}' | jinja2 charms/k8s-charm/src/nginx.conf.j2 > nginx.conf
      shell: bash
    - name: Build Juju Dashboard image
      shell: bash
      run: |
        cd '${{ github.workspace }}/juju-dashboard-local-release'
        DOCKER_BUILDKIT=1 docker build -t juju-dashboard-local:local .
    - name: Run the Docker image
      if: ${{ inputs.run == 'true' }}
      run: docker run --name juju-dashboard-local --detach juju-dashboard-local:local
      shell: bash
    - name: Wait for container to be ready
      if: ${{ inputs.run == 'true' }}
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 1
        max_attempts: 2
        command: while [ "$(docker inspect -f {{.State.Running}} juju-dashboard-local)" != "true" ]; do sleep 1; done
    - name: Get the dashboard address
      id: dashboard-address
      if: ${{ inputs.run == 'true' }}
      run: echo "address=$(docker container inspect juju-dashboard-local --format '{{ .NetworkSettings.IPAddress }}')" >> "$GITHUB_OUTPUT"
      shell: bash
