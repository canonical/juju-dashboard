name: "E2E tests: Juju, machine charm and local auth"

on:
  workflow_call:
    inputs:
      admin-password:
        required: false
        type: string
        description: The password to use when logging in as the admin user.
        default: password1
      juju-channel:
        required: false
        type: string
        description: Charm channel of Juju to use.
      send-notification:
        required: false
        type: boolean
        description: Whether to send a notification on failure.
        default: true

permissions: read-all

jobs:
  test:
    name: Run tests
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        node-version: [22.x]
    steps:
      - name: Checkout Juju Dashboard repo
        uses: actions/checkout@v6
      - name: Configure action
        id: config
        uses: ./.github/actions/prepare-action
      - name: Set up Juju
        uses: ./.github/actions/setup-juju
        with:
          provider: localhost
          controller-name: test
          juju-channel: ${{ inputs.juju-channel || steps.config.outputs.juju-channel }}
      - name: Set up access
        run: echo '${{ inputs.admin-password }}' | juju change-user-password --no-prompt
      - name: Compute Juju version for test identifier
        id: juju-version
        run: |
          CHANNEL="${{ inputs.juju-channel || steps.config.outputs.juju-channel }}"
          VERSION=$(echo "$CHANNEL" | cut -d'/' -f1)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: Set up Juju Dashboard machine charm
        uses: ./.github/actions/setup-machine-charm
        with:
          bundled-dashboard: ${{ steps.config.outputs.machine-bundled-dashboard }}
          dashboard-ref: ${{ steps.config.outputs.repo-ref }}
          charm-channel: ${{ steps.config.outputs.dashboard-charm-channel }}
          juju-version: ${{ steps.juju-version.outputs.version }}
      - name: Run tests
        uses: ./.github/actions/run-playwright
        with:
          test-identifier: e2e-juju-${{ steps.juju-version.outputs.version }}-machine-charm-local-auth
        env:
          CONTROLLER_NAME: test
          AUTH_MODE: local
          JUJU_ENV: juju
          PROVIDER: localhost
          ADMIN_USERNAME: admin
          ADMIN_PASSWORD: ${{ inputs.admin-password }}
      - name: Display logs
        if: failure()
        uses: ./.github/actions/failure-log
        with:
          juju-env: "juju"
          controller: "test"
      - name: Send notification on failure
        if: inputs.send-notification && steps.config.outputs.send-failure-notification && failure()
        uses: ./.github/actions/send-notification
        with:
          webhook-url: ${{ secrets.WEBBOT_URL }}
